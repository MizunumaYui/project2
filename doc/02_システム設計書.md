# キャラクターEC アプリケーション システム設計書

## 1. システム構成

### 1.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                      クライアント層                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  ブラウザ   │  │  スマホ     │  │  タブレット │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     フロントエンド層                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              React / Next.js                        │   │
│  │    - ユーザー画面（SPA）                             │   │
│  │    - 管理画面（SPA）                                 │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      バックエンド層                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Ruby on Rails (API モード)             │   │
│  │    - REST API                                       │   │
│  │    - 認証・認可                                      │   │
│  │    - ビジネスロジック                                │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       データ層                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  PostgreSQL  │  │    Redis     │  │  S3/Storage  │     │
│  │  (メインDB)  │  │ (キャッシュ) │  │   (画像)     │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技術スタック

| レイヤー | 技術 | バージョン |
|----------|------|-----------|
| フロントエンド | React | 18.x |
| フロントエンド | Next.js | 14.x |
| フロントエンド | TypeScript | 5.x |
| フロントエンド | Tailwind CSS | 3.x |
| バックエンド | Ruby | 3.3.x |
| バックエンド | Ruby on Rails | 7.x |
| データベース | PostgreSQL | 16.x |
| キャッシュ | Redis | 7.x |
| ストレージ | AWS S3 または MinIO | - |
| 認証 | JWT | - |
| インフラ | Docker | 24.x |
| インフラ | Docker Compose | 2.x |

---

## 2. データベース設計

### 2.1 ER図

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│    users     │     │  characters  │     │  categories  │
├──────────────┤     ├──────────────┤     ├──────────────┤
│ id (PK)      │     │ id (PK)      │     │ id (PK)      │
│ email        │     │ name         │     │ name         │
│ password     │     │ description  │     │ description  │
│ name         │     │ image_url    │     │ created_at   │
│ role         │     │ created_at   │     │ updated_at   │
│ created_at   │     │ updated_at   │     └──────────────┘
│ updated_at   │     │ deleted_at   │            │
└──────────────┘     └──────────────┘            │
       │                    │                    │
       │                    │                    │
       ▼                    ▼                    ▼
┌──────────────┐     ┌──────────────────────────────────┐
│    carts     │     │            products              │
├──────────────┤     ├──────────────────────────────────┤
│ id (PK)      │     │ id (PK)                          │
│ user_id (FK) │◄────│ character_id (FK)                │
│ created_at   │     │ category_id (FK)                 │
│ updated_at   │     │ name                             │
└──────────────┘     │ description                      │
       │             │ price                            │
       │             │ stock                            │
       ▼             │ image_url                        │
┌──────────────┐     │ created_at                       │
│  cart_items  │     │ updated_at                       │
├──────────────┤     │ deleted_at                       │
│ id (PK)      │     └──────────────────────────────────┘
│ cart_id (FK) │                    │
│ product_id   │◄───────────────────┘
│ quantity     │
│ created_at   │
└──────────────┘

┌──────────────┐     ┌──────────────┐
│    orders    │     │ order_items  │
├──────────────┤     ├──────────────┤
│ id (PK)      │◄────│ id (PK)      │
│ user_id (FK) │     │ order_id(FK) │
│ status       │     │ product_id   │
│ total_amount │     │ quantity     │
│ shipping_addr│     │ price        │
│ created_at   │     │ created_at   │
│ updated_at   │     └──────────────┘
└──────────────┘

┌──────────────────┐
│ user_favorites   │
├──────────────────┤
│ id (PK)          │
│ user_id (FK)     │
│ character_id(FK) │
│ created_at       │
└──────────────────┘
```

### 2.2 テーブル定義

#### users（ユーザー）
| カラム名 | データ型 | NULL | 説明 |
|----------|----------|------|------|
| id | UUID | NO | 主キー |
| email | VARCHAR(255) | NO | メールアドレス（ユニーク） |
| password | VARCHAR(255) | NO | ハッシュ化パスワード |
| name | VARCHAR(100) | NO | 表示名 |
| role | VARCHAR(20) | NO | 権限（user/admin） |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

#### characters（キャラクター）
| カラム名 | データ型 | NULL | 説明 |
|----------|----------|------|------|
| id | UUID | NO | 主キー |
| name | VARCHAR(100) | NO | キャラクター名 |
| description | TEXT | YES | 説明文 |
| image_url | VARCHAR(500) | YES | 画像URL |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |
| deleted_at | TIMESTAMP | YES | 削除日時（論理削除） |

#### products（商品）
| カラム名 | データ型 | NULL | 説明 |
|----------|----------|------|------|
| id | UUID | NO | 主キー |
| character_id | UUID | NO | キャラクターID（外部キー） |
| category_id | UUID | YES | カテゴリID（外部キー） |
| name | VARCHAR(200) | NO | 商品名 |
| description | TEXT | YES | 商品説明 |
| price | DECIMAL(10,2) | NO | 価格 |
| stock | INTEGER | NO | 在庫数 |
| image_url | VARCHAR(500) | YES | 商品画像URL |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |
| deleted_at | TIMESTAMP | YES | 削除日時（論理削除） |

#### orders（注文）
| カラム名 | データ型 | NULL | 説明 |
|----------|----------|------|------|
| id | UUID | NO | 主キー |
| user_id | UUID | NO | ユーザーID（外部キー） |
| status | VARCHAR(30) | NO | ステータス |
| total_amount | DECIMAL(12,2) | NO | 合計金額 |
| shipping_address | TEXT | NO | 配送先住所 |
| created_at | TIMESTAMP | NO | 注文日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

**注文ステータス**:
- `pending`: 支払い待ち
- `paid`: 支払い完了
- `preparing`: 発送準備中
- `shipped`: 発送済み
- `delivered`: 配達完了
- `cancelled`: キャンセル

---

## 3. ディレクトリ構成

```
project/                         # モノリポ構成
├── frontend/                    # フロントエンド (Next.js)
│   ├── src/
│   │   ├── app/                 # Next.js App Router
│   │   │   ├── (user)/          # ユーザー向けページ
│   │   │   │   ├── page.tsx            # トップページ
│   │   │   │   ├── characters/         # キャラクター一覧・詳細
│   │   │   │   ├── products/           # 商品一覧・詳細
│   │   │   │   ├── cart/               # カート
│   │   │   │   ├── checkout/           # 購入手続き
│   │   │   │   └── orders/             # 注文履歴
│   │   │   ├── (admin)/         # 管理者向けページ
│   │   │   │   ├── dashboard/          # ダッシュボード
│   │   │   │   ├── characters/         # キャラクター管理
│   │   │   │   ├── products/           # 商品管理
│   │   │   │   └── orders/             # 注文管理
│   │   │   └── (auth)/          # 認証ページ
│   │   │       ├── login/
│   │   │       └── register/
│   │   ├── components/          # 共通コンポーネント
│   │   │   ├── ui/              # UIコンポーネント
│   │   │   ├── layout/          # レイアウト
│   │   │   └── features/        # 機能別コンポーネント
│   │   ├── hooks/               # カスタムフック
│   │   ├── lib/                 # ユーティリティ
│   │   ├── stores/              # 状態管理
│   │   └── types/               # 型定義
│   ├── public/                  # 静的ファイル
│   ├── Dockerfile               # Next.js用Dockerfile
│   └── package.json
│
├── backend/                     # バックエンド (Ruby on Rails API)
│   ├── app/
│   │   ├── controllers/         # コントローラー
│   │   │   └── api/
│   │   │       └── v1/          # API v1
│   │   ├── models/              # Active Record モデル
│   │   ├── services/            # ビジネスロジック (Service Object)
│   │   ├── serializers/         # JSON シリアライザー
│   │   └── policies/            # 認可ポリシー (Pundit)
│   ├── config/
│   │   ├── routes.rb            # ルーティング
│   │   ├── database.yml         # DB設定
│   │   └── initializers/        # 初期化設定
│   ├── db/
│   │   ├── migrate/             # マイグレーション
│   │   ├── seeds.rb             # 初期データ
│   │   └── schema.rb            # スキーマ
│   ├── spec/                    # RSpec テスト
│   ├── Dockerfile               # Rails用Dockerfile
│   ├── Gemfile
│   └── Gemfile.lock
│
├── doc/                         # ドキュメント
├── docker-compose.yml           # Docker Compose 構成
├── docker-compose.dev.yml       # 開発用 Docker Compose
├── .env.example                 # 環境変数サンプル
└── README.md
```

---

## 4. セキュリティ設計

### 4.1 認証・認可

```
┌─────────────────────────────────────────────────────┐
│                   認証フロー                        │
└─────────────────────────────────────────────────────┘

1. ログイン
   Client ──[email/password]──> Server
   Server ──[JWT Token]──> Client

2. API アクセス
   Client ──[Authorization: Bearer <token>]──> Server
   Server ──[Token検証]──> 認可判定

3. トークン更新
   Client ──[Refresh Token]──> Server
   Server ──[New Access Token]──> Client
```

### 4.2 JWT トークン構成

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_id",
    "email": "user@example.com",
    "role": "user",
    "exp": 1234567890,
    "iat": 1234567890
  }
}
```

### 4.3 セキュリティ対策

| 脅威 | 対策 |
|------|------|
| SQLインジェクション | Active Record によるパラメータ化クエリ |
| XSS | React の自動エスケープ、CSP ヘッダー |
| CSRF | SameSite Cookie、CSRF トークン |
| パスワード漏洩 | bcrypt によるハッシュ化 (has_secure_password) |
| 中間者攻撃 | HTTPS 強制、HSTS ヘッダー |
